name: Validate CI/CD

on:
  # Only run on push to main, not on pull requests
  # This ensures PRs only trigger the main CI pipeline
  push:
    branches: [main]
    paths:
      - '.github/workflows/**/*.yml'
      - '.github/workflows/**/*.yaml'

jobs:
  validate:
    name: Validate CI/CD Configuration
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Validate YAML syntax
        shell: bash
        run: |
          echo "Validating YAML files..."
          ERROR_COUNT=0
          
          # Check workflow files
          for file in .github/workflows/*.yml; do
            if [ -f "$file" ]; then
              echo "Checking $file..."
              if ! python3 -c "import yaml; yaml.safe_load(open('$file'))" 2>/dev/null; then
                echo "❌ Invalid YAML: $file"
                ERROR_COUNT=$((ERROR_COUNT + 1))
              else
                echo "✓ Valid YAML: $file"
              fi
            fi
          done
          
          if [ $ERROR_COUNT -gt 0 ]; then
            echo "❌ Found $ERROR_COUNT YAML syntax error(s)"
            exit 1
          else
            echo "✓ All YAML files are valid"
          fi

      - name: Check for deprecated actions
        shell: bash
        run: |
          echo "Checking for deprecated action usage..."
          
          # Check for usage of removed actions
          if grep -r "uses:.*build-env-vars" .github/workflows/*.yml 2>/dev/null; then
            echo "❌ Error: build-env-vars action has been removed. Use direct environment variable setting instead."
            exit 1
          fi
          
          if grep -r "uses:.*test-env-vars" .github/workflows/*.yml 2>/dev/null; then
            echo "❌ Error: test-env-vars action does not exist. Use direct environment variable setting instead."
            exit 1
          fi
          
          echo "✓ Deprecated action check complete"


      - name: Validation Summary
        if: always()
        shell: bash
        run: |
          echo "## CI/CD Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ YAML syntax validation passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All workflow files are valid!" >> $GITHUB_STEP_SUMMARY

