name: E2E Tests

# Trigger on pull requests targeting main branch
on:
  pull_request:
    branches: [main]
    paths:
      - 'app/**'
      - 'lib/**'
      - 'e2e/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/e2e-tests.yml'

# Prevent overlapping workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Configuration constants - Update these values for easy maintenance
# These values are used throughout the workflow and passed to composite actions
# Note: GitHub Actions doesn't support workflow-level variables, so values are used directly

jobs:
  # Setup job: Install dependencies and cache artifacts for reuse by test jobs
  setup:
    name: Setup and Cache
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment
        with:
          node-version: '20'
          java-version: '17'
          java-distribution: 'temurin'

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright


  # Test jobs: Run in parallel using matrix strategy
  # Note: Test matrix configuration is also available in .github/workflows/test-matrix.json
  # for reference and potential future tooling. The matrix must be defined inline here
  # as GitHub Actions doesn't support loading matrix from external files natively.
  test:
    name: Test ${{ matrix.suite }}
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          - suite: Auth + Student
            test_paths: e2e/tests/auth/ e2e/tests/student/
            artifact_name: auth-student
          - suite: Supervisor
            test_paths: e2e/tests/supervisor/
            artifact_name: supervisor
          - suite: Admin
            test_paths: e2e/tests/admin/
            artifact_name: admin

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment
        with:
          node-version: '20'
          java-version: '17'
          java-distribution: 'temurin'

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright

      - name: Verify dependencies
        shell: bash
        run: |
          if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/playwright" ]; then
            echo "Dependencies not found, installing..."
            npm ci --prefer-offline --no-audit
          else
            echo "Dependencies found in cache"
          fi

      - name: Type check
        shell: bash
        run: |
          echo "Running TypeScript type check..."
          if ! npm run typecheck; then
            echo "ERROR: TypeScript type check failed!"
            echo "This may cause test failures. Fix type errors before running tests."
            exit 1
          fi
          echo "✓ TypeScript type check passed"
      
      - name: Verify Playwright can resolve imports
        shell: bash
        run: |
          echo "Checking if Playwright can resolve path aliases..."
          # Use the Playwright tsconfig to verify path resolution
          if ! npx tsc --project tsconfig.playwright.json --noEmit 2>&1 | head -30; then
            echo "WARNING: TypeScript compilation check found issues"
            echo "This may indicate path alias resolution problems"
            echo "Continuing with tests..."
          else
            echo "✓ Path alias resolution check passed"
          fi

      - name: Set test environment variables
        uses: ./.github/actions/test-env-vars
        with:
          project-id: 'demo-test'
          base-url: 'http://localhost:3000'

      - name: Verify Firebase configuration
        shell: bash
        run: |
          echo "Verifying Firebase configuration..."
          if [ ! -f "firebase.json" ]; then
            echo "ERROR: firebase.json not found!"
            exit 1
          fi
          if [ ! -f "firestore.rules" ]; then
            echo "WARNING: firestore.rules not found"
          fi
          echo "✓ Firebase configuration verified"

      - name: Start Firebase Emulators
        uses: ./.github/actions/firebase-emulators
        with:
          action: start
          project-id: 'demo-test'
          max-attempts: '30'
          emulator-ui-port: '4000'

      - name: Export environment variables for Playwright
        shell: bash
        run: |
          echo "Ensuring all environment variables are available for Playwright webServer..."
          # Explicitly export all Firebase-related environment variables
          echo "FIREBASE_AUTH_EMULATOR_HOST=$FIREBASE_AUTH_EMULATOR_HOST" >> $GITHUB_ENV
          echo "FIRESTORE_EMULATOR_HOST=$FIRESTORE_EMULATOR_HOST" >> $GITHUB_ENV
          # Export all NEXT_PUBLIC_ variables that are already set
          env | grep "^NEXT_PUBLIC_" | while IFS= read -r line; do
            echo "$line" >> $GITHUB_ENV || true
          done
          echo "✓ Environment variables exported"

      - name: Validate Playwright Config
        shell: bash
        run: |
          echo "Validating Playwright configuration..."
          OUTPUT=$(npx playwright test --list 2>&1)
          if [ $? -ne 0 ]; then
            echo "ERROR: Playwright configuration is invalid!"
            echo "$OUTPUT"
            exit 1
          fi
          echo "✓ Playwright configuration is valid"
          echo "Found tests:"
          echo "$OUTPUT" | grep -E "^\s+[0-9]+" | head -20 || echo "$OUTPUT" | head -20

      - name: Health Check Services
        shell: bash
        run: |
          echo "Performing health checks before running tests..."
          echo ""
          echo "Checking Firebase Emulators:"
          if curl -f -s http://localhost:4000 > /dev/null 2>&1; then
            echo "✓ Emulator UI is running on port 4000"
          else
            echo "✗ Emulator UI is NOT running on port 4000"
            exit 1
          fi
          if curl -f -s http://localhost:9099 > /dev/null 2>&1 || nc -z localhost 9099 2>/dev/null; then
            echo "✓ Auth Emulator is running on port 9099"
          else
            echo "⚠ Auth Emulator port check (may be normal if not HTTP)"
          fi
          if curl -f -s http://localhost:8080 > /dev/null 2>&1 || nc -z localhost 8080 2>/dev/null; then
            echo "✓ Firestore Emulator is running on port 8080"
          else
            echo "⚠ Firestore Emulator port check (may be normal if not HTTP)"
          fi
          echo ""
          echo "Waiting for Next.js server to be ready..."
          MAX_WAIT=60
          WAIT_COUNT=0
          while [ $WAIT_COUNT -lt $MAX_WAIT ]; do
            if curl -f -s http://localhost:3000 > /dev/null 2>&1; then
              echo "✓ Next.js server is running on port 3000"
              break
            fi
            WAIT_COUNT=$((WAIT_COUNT + 1))
            if [ $WAIT_COUNT -eq $MAX_WAIT ]; then
              echo "✗ Next.js server did not start within $MAX_WAIT seconds"
              echo "Checking for Next.js process:"
              ps aux | grep -E "[n]ext|node.*dev" || echo "No Next.js process found"
              exit 1
            fi
            sleep 1
          done
          echo "✓ All services are healthy"

      - name: Run Tests
        shell: bash
        run: |
          echo "Running tests for: ${{ matrix.suite }}"
          echo "Test paths: ${{ matrix.test_paths }}"
          echo ""
          echo "Environment variables:"
          echo "  E2E_TEST=$E2E_TEST"
          echo "  CI=$CI"
          echo "  NODE_ENV=$NODE_ENV"
          echo "  E2E_BASE_URL=$E2E_BASE_URL"
          echo "  FIREBASE_AUTH_EMULATOR_HOST=$FIREBASE_AUTH_EMULATOR_HOST"
          echo "  FIRESTORE_EMULATOR_HOST=$FIRESTORE_EMULATOR_HOST"
          echo "  NEXT_PUBLIC_FIREBASE_PROJECT_ID=$NEXT_PUBLIC_FIREBASE_PROJECT_ID"
          echo ""
          echo "Verifying Playwright installation:"
          npx playwright --version || echo "Playwright not found"
          echo ""
          echo "Checking test files exist:"
          # Split test_paths by space and check each path
          # Trim whitespace and filter empty strings
          TEST_PATHS_ARRAY=()
          for path in ${{ matrix.test_paths }}; do
            # Trim leading/trailing whitespace
            path=$(echo "$path" | xargs)
            # Skip empty paths
            [ -z "$path" ] && continue
            if [ -d "$path" ] || [ -f "$path" ]; then
              echo "✓ Found: $path"
              ls -la "$path" | head -5
              TEST_PATHS_ARRAY+=("$path")
            else
              echo "✗ Not found: $path"
            fi
          done
          echo ""
          if [ ${#TEST_PATHS_ARRAY[@]} -eq 0 ]; then
            echo "ERROR: No test paths found!"
            exit 1
          fi
          echo "Starting tests with paths: ${TEST_PATHS_ARRAY[*]}"
          set -o pipefail
          # Use array expansion to pass paths correctly to Playwright
          # Capture both stdout and stderr, and save exit code
          npx playwright test "${TEST_PATHS_ARRAY[@]}" 2>&1 | tee test-output.log
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo ""
            echo "=========================================="
            echo "Tests failed with exit code: $TEST_EXIT_CODE"
            echo "Full output:"
            echo "=========================================="
            cat test-output.log || true
            echo ""
            echo "=========================================="
            echo "Service Health Status:"
            echo "=========================================="
            echo "Next.js server:"
            curl -f http://localhost:3000 > /dev/null 2>&1 && echo "✓ Running on port 3000" || echo "✗ NOT running on port 3000"
            echo ""
            echo "Firebase Emulators:"
            curl -f http://localhost:4000 > /dev/null 2>&1 && echo "✓ UI running on port 4000" || echo "✗ UI NOT running on port 4000"
            nc -z localhost 9099 2>/dev/null && echo "✓ Auth emulator port 9099 open" || echo "✗ Auth emulator port 9099 closed"
            nc -z localhost 8080 2>/dev/null && echo "✓ Firestore emulator port 8080 open" || echo "✗ Firestore emulator port 8080 closed"
            echo ""
            echo "Playwright Report:"
            if [ -d "playwright-report" ]; then
              echo "✓ Report directory exists"
              echo "Report files:"
              ls -la playwright-report/ | head -10
            else
              echo "✗ Report directory not found"
            fi
            echo ""
            echo "Process Status:"
            echo "Next.js processes:"
            ps aux | grep -E "[n]ext|node.*dev" || echo "No Next.js processes found"
            echo ""
            echo "Firebase processes:"
            ps aux | grep -E "[f]irebase|[j]ava.*firebase" || echo "No Firebase processes found"
            exit $TEST_EXIT_CODE
          fi

      - name: Stop Firebase Emulators
        if: always()
        uses: ./.github/actions/firebase-emulators
        with:
          action: stop

      - name: Upload test output logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output-${{ matrix.artifact_name }}
          path: test-output.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Test Summary
        if: always()
        shell: bash
        run: |
          echo "## E2E Test Results - ${{ matrix.suite }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Paths: ${{ matrix.test_paths }}" >> $GITHUB_STEP_SUMMARY
          if [ -f "test-output.log" ]; then
            echo "### Test Output" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 test-output.log >> $GITHUB_STEP_SUMMARY || true
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ All tests passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "❌ Tests failed. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload test artifacts
        if: always()
        uses: ./.github/actions/upload-test-artifacts
        with:
          artifact-name: ${{ matrix.artifact_name }}

  # Aggregate results from all test jobs
  aggregate-results:
    name: Aggregate Test Results
    needs: test
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 5

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: all-results/

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: all-test-results
          path: all-results/
          retention-days: 30
          if-no-files-found: ignore
