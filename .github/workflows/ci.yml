name: CI Pipeline

# Trigger on pull requests targeting main branch
on:
  pull_request:
    branches: [main]

# Prevent overlapping workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Shared environment variables
env:
  NODE_VERSION: '20'
  JAVA_VERSION: '21'
  PROJECT_ID: 'demo-test'

jobs:
  # Fast checks that run in parallel
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Run ESLint
        run: npm run lint

      - name: Lint Summary
        if: always()
        uses: ./.github/actions/job-summary
        with:
          job-name: 'Lint'
          status: ${{ job.status }}

  build:
    name: Build Application
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Set build environment variables
        uses: ./.github/actions/build-env-vars
        with:
          project-id: ${{ env.PROJECT_ID }}

      - name: Type check
        run: npm run typecheck

      - name: Build application
        run: npm run build

      - name: Build Summary
        if: always()
        uses: ./.github/actions/job-summary
        with:
          job-name: 'Build'
          status: ${{ job.status }}
          details: |
            - Type check: ✅ Passed
            - Build: ✅ Passed

  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        continue-on-error: true
        with:
          fail-on-severity: moderate
        # Note: This step requires Dependency Graph to be enabled in repository settings
        # If it fails, enable it at: https://github.com/Roee-Bar/MentorMatch/settings/security_analysis

      - name: Run npm audit (moderate and above)
        continue-on-error: true
        run: |
          echo "Running npm audit for moderate and high severity issues..."
          npm audit --audit-level=moderate || true

      - name: Run npm audit (high severity only)
        continue-on-error: true
        run: |
          echo "Checking for high severity vulnerabilities..."
          if npm audit --audit-level=high; then
            echo "✅ No high severity vulnerabilities found!"
          else
            echo "⚠️ High severity vulnerabilities detected!"
            echo "Please review and update dependencies when possible."
            echo "Run 'npm audit' for details."
          fi

      - name: Security Summary
        if: always()
        uses: ./.github/actions/job-summary
        with:
          job-name: 'Security Scan'
          status: ${{ job.status }}
          details: |
            **Note:** If you see a 'Dependency review is not supported' error, enable the Dependency Graph in repository settings:
            https://github.com/Roee-Bar/MentorMatch/settings/security_analysis

  # E2E Tests - Only run if relevant files changed
  e2e-setup:
    name: E2E Setup
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should_run: ${{ steps.check-e2e.outputs.should_run }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if E2E tests should run
        id: check-e2e
        shell: bash
        run: |
          # Get the base branch
          BASE_BRANCH="${{ github.base_ref }}"
          if [ -z "$BASE_BRANCH" ]; then
            BASE_BRANCH="main"
          fi
          
          # Fetch base branch to compare
          git fetch origin $BASE_BRANCH:$BASE_BRANCH || true
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only $BASE_BRANCH...HEAD 2>/dev/null || git diff --name-only origin/$BASE_BRANCH...HEAD 2>/dev/null || echo "")
          
          echo "Changed files:"
          echo "$CHANGED_FILES" | head -20
          
          # Check if any relevant files changed
          if echo "$CHANGED_FILES" | grep -qE "(^app/|^lib/|^e2e/|playwright\.config\.ts|package\.json|package-lock\.json|\.github/workflows/ci\.yml)"; then
            echo "should_run=true" >> $GITHUB_OUTPUT
            echo "E2E tests will run - relevant files changed"
          else
            echo "should_run=false" >> $GITHUB_OUTPUT
            echo "E2E tests will be skipped - no relevant files changed"
          fi

      - name: Setup test environment
        if: steps.check-e2e.outputs.should_run == 'true'
        uses: ./.github/actions/setup-test-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          java-version: ${{ env.JAVA_VERSION }}
          java-distribution: 'temurin'

      - name: Setup Playwright browsers
        if: steps.check-e2e.outputs.should_run == 'true'
        uses: ./.github/actions/setup-playwright

  load-matrix:
    name: Load Test Matrix
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Read test matrix
        id: set-matrix
        run: |
          {
            echo 'matrix<<MATRIX_EOF'
            cat .github/workflows/test-matrix.json
            echo 'MATRIX_EOF'
          } >> $GITHUB_OUTPUT

  e2e-tests:
    name: E2E Test - ${{ matrix.suite }}
    needs: [lint, build, security, e2e-setup, load-matrix]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: needs.e2e-setup.outputs.should_run == 'true'
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.load-matrix.outputs.matrix) }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup test environment
        uses: ./.github/actions/setup-test-environment
        with:
          node-version: ${{ env.NODE_VERSION }}
          java-version: ${{ env.JAVA_VERSION }}
          java-distribution: 'temurin'

      - name: Setup Playwright browsers
        uses: ./.github/actions/setup-playwright

      - name: Verify dependencies
        shell: bash
        run: |
          if [ ! -d "node_modules" ] || [ ! -f "node_modules/.bin/playwright" ]; then
            echo "Dependencies not found, installing..."
            npm ci --prefer-offline --no-audit
          else
            echo "Dependencies found in cache"
          fi

      - name: Type check
        shell: bash
        run: |
          echo "Running TypeScript type check..."
          if ! npm run typecheck; then
            echo "ERROR: TypeScript type check failed!"
            echo "This may cause test failures. Fix type errors before running tests."
            exit 1
          fi
          echo "✓ TypeScript type check passed"
      
      - name: Verify Playwright can resolve imports
        shell: bash
        run: |
          echo "Checking if Playwright can resolve path aliases..."
          # Use the Playwright tsconfig to verify path resolution
          if ! npx tsc --project tsconfig.playwright.json --noEmit 2>&1 | head -30; then
            echo "WARNING: TypeScript compilation check found issues"
            echo "This may indicate path alias resolution problems"
            echo "Continuing with tests..."
          else
            echo "✓ Path alias resolution check passed"
          fi

      - name: Set test environment variables
        uses: ./.github/actions/test-env-vars
        with:
          project-id: ${{ env.PROJECT_ID }}
          base-url: 'http://localhost:3000'

      - name: Start Firebase Emulators
        uses: ./.github/actions/firebase-emulators
        with:
          action: start
          project-id: ${{ env.PROJECT_ID }}
          max-attempts: '30'
          emulator-ui-port: '4000'

      - name: Export environment variables for Playwright
        shell: bash
        run: |
          echo "Ensuring all environment variables are available for Playwright webServer..."
          # Explicitly export all Firebase-related environment variables
          echo "FIREBASE_AUTH_EMULATOR_HOST=$FIREBASE_AUTH_EMULATOR_HOST" >> $GITHUB_ENV
          echo "FIRESTORE_EMULATOR_HOST=$FIRESTORE_EMULATOR_HOST" >> $GITHUB_ENV
          # Export all NEXT_PUBLIC_ variables that are already set
          env | grep "^NEXT_PUBLIC_" | while IFS= read -r line; do
            echo "$line" >> $GITHUB_ENV || true
          done
          echo "✓ Environment variables exported"

      - name: Validate Playwright Config
        shell: bash
        run: |
          echo "Validating Playwright configuration..."
          
          # Validate TypeScript config file syntax
          echo "Checking config file TypeScript syntax..."
          if npx tsc --noEmit playwright.config.ts 2>&1 | grep -q "error TS"; then
            echo "ERROR: TypeScript errors in playwright.config.ts"
            npx tsc --noEmit playwright.config.ts 2>&1 | grep "error TS" | head -10
            exit 1
          fi
          echo "✓ Config file TypeScript syntax is valid"
          
          # Try to list tests - this validates the config structure
          # Note: This may attempt to start webServer, so we handle errors gracefully
          echo "Validating Playwright config structure..."
          set +e  # Don't exit on error immediately
          OUTPUT=$(timeout 30 npx playwright test --list 2>&1)
          EXIT_CODE=$?
          set -e  # Re-enable exit on error
          
          if [ $EXIT_CODE -eq 0 ]; then
            echo "✓ Playwright configuration is valid"
            echo "Found tests:"
            echo "$OUTPUT" | grep -E "^\s+[0-9]+" | head -20 || echo "$OUTPUT" | tail -20
          else
            # Check if it's a webServer or connection error (expected before services are ready)
            if echo "$OUTPUT" | grep -qiE "(webServer|ECONNREFUSED|ECONNRESET|timeout|starting|Unable to start)"; then
              echo "⚠️ WebServer not ready yet (expected at this stage)"
              echo "Config structure is valid - webServer will start during test execution"
            elif [ $EXIT_CODE -eq 124 ]; then
              echo "⚠️ Test listing timed out (webServer may be starting)"
              echo "Config structure appears valid - continuing with tests"
            else
              # It's likely a real config error - show it but don't fail if it's just webServer
              echo "⚠️ Playwright validation had issues:"
              echo "$OUTPUT" | head -20
              echo ""
              echo "Note: If this is webServer-related, tests will still run."
              echo "If this is a config error, tests will fail with more details."
            fi
          fi
          echo "✓ Config validation complete - proceeding with tests"

      - name: Health Check Services
        uses: ./.github/actions/health-check-services

      - name: Run Tests
        uses: ./.github/actions/run-e2e-tests
        with:
          test-paths: ${{ matrix.test_paths }}
          suite-name: ${{ matrix.suite }}

      - name: Stop Firebase Emulators
        if: always()
        uses: ./.github/actions/firebase-emulators
        with:
          action: stop

      - name: Upload test output logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-output-${{ matrix.artifact_name }}
          path: test-output.log
          retention-days: 7
          if-no-files-found: ignore

      - name: Test Summary
        if: always()
        uses: ./.github/actions/job-summary
        with:
          job-name: "E2E Test - ${{ matrix.suite }}"
          status: ${{ job.status }}
          details: |
            - Test Paths: ${{ matrix.test_paths }}

      - name: Upload test artifacts
        if: always()
        uses: ./.github/actions/upload-test-artifacts
        with:
          artifact-name: ${{ matrix.artifact_name }}

  # Aggregate E2E test results
  e2e-aggregate:
    name: Aggregate E2E Test Results
    needs: [e2e-setup, e2e-tests]
    runs-on: ubuntu-latest
    if: always() && needs.e2e-setup.outputs.should_run == 'true'
    timeout-minutes: 5

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*
          merge-multiple: true
          path: all-results/

      - name: Upload combined results
        uses: actions/upload-artifact@v4
        with:
          name: all-test-results
          path: all-results/
          retention-days: 30
          if-no-files-found: ignore

  # Final summary job
  ci-summary:
    name: CI Pipeline Summary
    needs: [lint, build, security, e2e-setup]
    runs-on: ubuntu-latest
    if: always()
    timeout-minutes: 2

    steps:
      - name: Generate Summary
        shell: bash
        run: |
          echo "# CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Job Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Lint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security.result }} |" >> $GITHUB_STEP_SUMMARY
          
          # Check E2E status
          E2E_SHOULD_RUN="${{ needs.e2e-setup.outputs.should_run }}"
          if [ "$E2E_SHOULD_RUN" == "true" ]; then
            echo "| E2E Tests | See individual test jobs above |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests | skipped (no relevant files changed) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          LINT_STATUS="${{ needs.lint.result }}"
          BUILD_STATUS="${{ needs.build.result }}"
          SECURITY_STATUS="${{ needs.security.result }}"
          
          if [ "$LINT_STATUS" == "success" ] && [ "$BUILD_STATUS" == "success" ] && [ "$SECURITY_STATUS" == "success" ]; then
            if [ "$E2E_SHOULD_RUN" != "true" ]; then
              echo "✅ **All CI checks passed!**" >> $GITHUB_STEP_SUMMARY
              echo "E2E tests were skipped as no relevant files changed." >> $GITHUB_STEP_SUMMARY
            else
              echo "✅ **Fast checks passed!**" >> $GITHUB_STEP_SUMMARY
              echo "E2E tests are running. Check individual test jobs for results." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "❌ **Some CI checks failed. Please review the logs above.**" >> $GITHUB_STEP_SUMMARY
          fi

