name: 'Setup Environment Variables'
description: 'Unified action to set up environment variables for tests, builds, or Playwright'

inputs:
  context:
    description: 'Context: test, build, or playwright'
    required: true
  project-id:
    description: 'Firebase project ID'
    required: false
    default: 'demo-test'
  base-url:
    description: 'Base URL for E2E tests (used in test/playwright contexts)'
    required: false
    default: 'http://localhost:3000'
  api-key:
    description: 'Firebase API key (used in build context)'
    required: false
    default: 'test-api-key'
  auth-domain:
    description: 'Firebase Auth domain (used in build context)'
    required: false
    default: 'localhost'
  storage-bucket:
    description: 'Firebase Storage bucket (used in build context, auto-generated if not provided)'
    required: false
    default: ''
  messaging-sender-id:
    description: 'Firebase Messaging Sender ID (used in build context)'
    required: false
    default: '123456789'
  app-id:
    description: 'Firebase App ID (used in build context)'
    required: false
    default: '1:123456789:web:test'

runs:
  using: 'composite'
  steps:
    - name: Setup environment variables
      shell: bash
      run: |
        CONTEXT="${{ inputs.context }}"
        PROJECT_ID="${{ inputs.project-id }}"
        BASE_URL="${{ inputs.base-url }}"
        
        echo "Setting up environment variables for context: $CONTEXT"
        
        # Common variables for all contexts
        if [ "$CONTEXT" = "test" ] || [ "$CONTEXT" = "playwright" ]; then
          echo "E2E_TEST=true" >> $GITHUB_ENV
          echo "NODE_ENV=test" >> $GITHUB_ENV
          echo "CI=true" >> $GITHUB_ENV
          echo "E2E_BASE_URL=$BASE_URL" >> $GITHUB_ENV
          
          # Firebase Emulator settings
          echo "FIREBASE_AUTH_EMULATOR_HOST=localhost:9099" >> $GITHUB_ENV
          echo "FIRESTORE_EMULATOR_HOST=localhost:8081" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_AUTH_EMULATOR_HOST=localhost:9099" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIRESTORE_EMULATOR_HOST=localhost:8081" >> $GITHUB_ENV
          
          # Firebase test configuration
          echo "NEXT_PUBLIC_FIREBASE_API_KEY=test-api-key" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=localhost" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$PROJECT_ID.appspot.com" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=123456789" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_APP_ID=1:123456789:web:test" >> $GITHUB_ENV
          echo "FIREBASE_ADMIN_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
        fi
        
        # Build context variables
        if [ "$CONTEXT" = "build" ]; then
          echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ inputs.api-key }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ inputs.auth-domain }}" >> $GITHUB_ENV
          
          # Handle storage bucket
          STORAGE_BUCKET="${{ inputs.storage-bucket }}"
          if [ -z "$STORAGE_BUCKET" ] || [ "$STORAGE_BUCKET" == "" ]; then
            echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$PROJECT_ID.appspot.com" >> $GITHUB_ENV
          else
            echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=$STORAGE_BUCKET" >> $GITHUB_ENV
          fi
          
          echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ inputs.messaging-sender-id }}" >> $GITHUB_ENV
          echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ inputs.app-id }}" >> $GITHUB_ENV
        fi
        
        # Playwright-specific: Export variables for webServer
        if [ "$CONTEXT" = "playwright" ]; then
          echo "Ensuring all environment variables are available for Playwright webServer..."
          # Re-export Firebase emulator variables (they should already be set above)
          echo "FIREBASE_AUTH_EMULATOR_HOST=$FIREBASE_AUTH_EMULATOR_HOST" >> $GITHUB_ENV
          echo "FIRESTORE_EMULATOR_HOST=$FIRESTORE_EMULATOR_HOST" >> $GITHUB_ENV
          
          # Export all NEXT_PUBLIC_ variables that are already set
          # Filter out any variables that might contain sensitive data (safety check)
          env | grep "^NEXT_PUBLIC_" | grep -vE "(PRIVATE_KEY|SECRET|PASSWORD|CREDENTIAL|API_KEY|AUTH_TOKEN)" | while IFS= read -r line; do
            echo "$line" >> $GITHUB_ENV || true
          done
          echo "✓ Environment variables exported for Playwright"
        fi
        
        echo "✓ Environment variables set up for $CONTEXT context"

